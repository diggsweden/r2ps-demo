<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">

  <!-- Styles -->
  <script src="webjars/jquery/3.7.1/jquery.min.js"></script>
  <script src="webjars/popper.js/1.16.1-lts/dist/umd/popper.min.js"></script>
  <script src="webjars/bootstrap/5.3.3/js/bootstrap.min.js"></script>
  <script src="webjars/highlightjs/11.5.0/highlight.min.js"></script>
  <script src="js/main.js"></script>
  <!-- Styles -->
  <link rel="stylesheet" href="css/bootstrap.min.css"/>
  <link rel="stylesheet" href="css/services.css"/>
  <link rel="stylesheet" href="webjars/font-awesome/6.5.2/css/all.min.css"/>
  <link rel="stylesheet" href="webjars/highlightjs/11.5.0/styles/atom-one-light.min.css">
  <link rel="stylesheet" href="webjars/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css">
  <title>Remote HSM Wallet Client</title>
</head>

<body>
<div class="main-container">
  <div class="content-wrapper">
    <div class="header-section">
      <div class="logo-area">
        <i class="bi bi-shield-lock fs-1 text-primary me-3"></i>
        <div>
          <h1 class="app-title">Remote HSM Wallet Client</h1>
          <p class="app-subtitle">Secure Digital Wallet Services</p>
        </div>
      </div>
    </div>
    <a class="btn btn-primary float-end mt-2 me-2" href="logout">Logout</a>

    <div class="content-section w-100">
      <div class="welcome-message">
        <h6>Active Sessions</h6>
        <table class="table table-striped table-sm">
          <thead>
          <tr>
            <th>Context</th>
            <th>Session ID</th>
            <th>Purpose</th>
            <th>Expires</th>
            <th>Delete</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="hsmsession : ${sessions}">
            <td th:text="${hsmsession.getContext()}"></td>
            <td th:text="${hsmsession.getSessionId()}"></td>
            <td th:text="${hsmsession.getPurpose()}"></td>
            <td th:text="${hsmsession.getExpires()}"></td>
            <td><a th:href="'delete-session?sessionId=' + ${hsmsession.getSessionId()}"><i class="bi bi-trash"></i></a></td>
          </tr>
          </tbody>
        </table>
      </div>
      <div class="w-100">
        <hr>
        <div class="row w-100">
          <div class="col-3 pt-0">
            <div class="auth-container">
              <div class="d-flex flex-column gap-4 p-4 mt-0">
                <button type="button" class="btn btn-outline-primary auth-btn" data-bs-toggle="modal" data-bs-target="#createSessionModal">
                  <i class="bi bi-file-earmark-lock2 me-2"></i>
                  Create session
                </button>
                <a href="list-keys" class="btn btn-outline-primary auth-btn">
                  <i class="bi bi-card-checklist me-2"></i>
                  List HSM keys
                </a>
                <button type="button" class="btn btn-outline-primary auth-btn" data-bs-toggle="modal" data-bs-target="#createKeyModal">
                  <i class="bi bi-key me-2"></i>
                  Create HSM key
                </button>
                <button type="button" class="btn btn-outline-primary auth-btn" data-bs-toggle="modal" data-bs-target="#deleteKeyModal">
                  <i class="bi bi-trash me-2"></i>
                  Delete HSM key
                </button>
                <button type="button" class="btn btn-outline-primary auth-btn" data-bs-toggle="modal" data-bs-target="#signModal">
                  <i class="bi bi-pencil-square me-2"></i>
                  Sign with HSM key
                </button>
              </div>
            </div>
          </div>
          <div class="col-9 pe-0 me-0">
            <div class="border border-primary rounded p-3 mt-3 me-0" style="min-height: 400px;">
              <th:block th:if="${info != null}">
                <div class="text-primary mb-2" th:utext="${info}"></div>
              </th:block>
              <th:block th:if="${json != null}">
                <pre class="mb-2"><code th:utext="${json}"></code></pre>
              </th:block>
              <th:block th:if="${json2 != null}">
                <pre class="mb-2"><code th:utext="${json2}"></code></pre>
              </th:block>
              <th:block th:if="${text != null}">
                <textarea readonly class="form-control bg-light font-monospace border-0 auto-grow" style="resize: none;"
                          th:text="${text}"></textarea>
              </th:block>
              <!-- Your diagnostic text content goes here -->
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Sign modal -->
<div class="modal fade" id="signModal" tabindex="-1" aria-labelledby="signLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="singKeyLabel">Sign with HSM Key</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="sign" method="post">
          <div class="mb-3">
            <label for="signType" class="form-label">Signature Type</label>
            <select class="form-control" id="signType" name="type" required>
              <option value="ECDSA">ECDSA</option>
              <option value="HS256-PKDS">HS256-PKDS</option>
              <option value="HS384-PKDS">HS384-PKDS</option>
              <option value="HS512-PKDS">HS512-PKDS</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="signCurve" class="form-label">Curve</label>
            <select class="form-control" id="signCurve" name="curve" required>
              <option value="P-256">P-256</option>
              <option value="P-384">P-384</option>
              <option value="P-521">P-521</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="signSessionPurpose" class="form-label">Purpose</label>
            <input type="text" class="form-control" id="signSessionPurpose" name="purpose"
                   th:value="${T(se.digg.wallet.rhsm.commons.SessionTaskId).sign.name()}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Key Selection</label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="selectKey" id="selectKeyOldest" value="oldest"
                     required checked>
              <label class="form-check-label" for="selectKeyOldest">
                Oldest
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="selectKey" id="selectKeyRecent" value="most-recent"
                     required>
              <label class="form-check-label" for="selectKeyRecent">
                Most Recent
              </label>
            </div>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Sign</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete key modal -->
<div class="modal fade" id="deleteKeyModal" tabindex="-1" aria-labelledby="createkeyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteSessionKeyLabel">Delete Oldest HSM Key</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="delete-key" method="post">
          <div class="mb-3">
            <label for="deleteKeyCurve" class="form-label">Curve</label>
            <select class="form-control" id="deleteKeyCurve" name="curve" required>
              <option value="P-256">P-256</option>
              <option value="P-384">P-384</option>
              <option value="P-521">P-521</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Key Selection</label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="selectKey" id="deleteKeyOldest" value="oldest"
                     required checked>
              <label class="form-check-label" for="deleteKeyOldest">
                Oldest
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="selectKey" id="deleteKeyRecent" value="most-recent"
                     required>
              <label class="form-check-label" for="deleteKeyRecent">
                Most Recent
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="selectKey" id="deleteKeyById" value="by-id"
                     required>
              <label class="form-check-label" for="deleteKeyById">
                By Key Identifier
              </label>
            </div>
          </div>
          <div class="mb-3 d-none" id="deleteKeyIdGroup">
            <label for="deleteKeyId" class="form-label">Key Identifier</label>
            <input type="text" class="form-control" id="deleteKeyId" name="kid" autocomplete="off" disabled>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Delete</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const radios = document.querySelectorAll('input[name="selectKey"]');
        const byIdRadio = document.getElementById('deleteKeyById');
        const group = document.getElementById('deleteKeyIdGroup');
        const input = document.getElementById('deleteKeyId');

        function updateVisibility() {
            const show = byIdRadio.checked;
            group.classList.toggle('d-none', !show);
            input.required = show;
            input.disabled = !show;
            if (!show) input.value = '';
        }

        radios.forEach(r => r.addEventListener('change', updateVisibility));
        updateVisibility();
    });
</script>

<!-- Create key modal -->
<div class="modal fade" id="createKeyModal" tabindex="-1" aria-labelledby="createKeyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createSessionKeyLabel">Create HSM Key</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="create-key" method="post">
          <div class="mb-3">
            <label for="createKeyCurve" class="form-label">Curve</label>
            <select class="form-control" id="createKeyCurve" name="curve" required>
              <option value="P-256">P-256</option>
              <option value="P-384">P-384</option>
              <option value="P-521">P-521</option>
            </select>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Create</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Create Session modal -->
<div class="modal fade" id="createSessionModal" tabindex="-1" aria-labelledby="createSessionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createSessionModalLabel">Create Session</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="create-session" method="post">
          <div class="mb-3">
            <label for="createSessionContext" class="form-label">Context</label>
            <select class="form-control" id="createSessionContext" name="context" required>
              <option value="hsm">hsm</option>
              <option value="wallet">wallet</option>
              <option value="bad-context">bad-context</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="createSessionPurpose" class="form-label">Purpose</label>
            <input type="text" class="form-control" id="createSessionPurpose" name="purpose" value="sign" required>
          </div>
          <div class="mb-3">
            <label for="createSessionPin" class="form-label">PIN</label>
            <input type="password" class="form-control" id="createSessionPin" name="pin" required>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Create</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Notification Modal -->
<div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true"
     th:if="${message != null or errorMessage != null}">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" th:classappend="${errorMessage != null ? 'border-danger' : 'border-success'}">
      <div class="modal-header border-0"
           th:classappend="${errorMessage != null ? 'bg-danger-subtle' : 'bg-success-subtle'}">
        <h5 class="modal-title" id="notificationModalLabel">
          <i class="bi" th:classappend="${errorMessage != null ? 'bi-exclamation-circle-fill text-danger' : 'bi-check-circle-fill text-success'}"></i>
          <span th:text="${errorMessage != null ? 'Error' : 'Success'}">Notification</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <p class="mb-0" th:utext="${errorMessage != null ? errorMessage : message}"></p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn"
                th:classappend="${errorMessage != null ? 'btn-outline-danger' : 'btn-outline-success'}"
                data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Message or error message modal load script -->
<script th:if="${message != null or errorMessage != null}">
    document.addEventListener('DOMContentLoaded', function() {
        var notificationModal = new bootstrap.Modal(document.getElementById('notificationModal'));
        notificationModal.show();

        // Optional: Auto-hide after 5 seconds
        setTimeout(function() {
            notificationModal.hide();
        }, 5000);
    });
</script>


</body>
</html>
